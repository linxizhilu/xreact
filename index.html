<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <div id="app"></div>
    <button id="change">切换</button>
</body>
<script type="text/javascript">
    var components = {};
        compUid = 0;
    var util = {
        ary :[],
        slice : ([]).slice
    }
    function Component(state,name){
        // number 每个插件一个id编号
        this.compUid = ++compUid;
        // 名称每个实例一个唯一名称
        this.name = name || 'name'+this.compUid;
        // object 用来存放组件自有数据
        this.state = state || {};
        // node 存放生成的组件节点
        this.node = null;
        // object 存放父级传入的数据
        this.props = {};
        // string 存放children的html结构
        this.children = '';
        // number 存放当前版本，数据更新后改变
        this.version = this.version || Math.random();
        // object 存放当前组件所调用的子组件
        this.subComponents = {
            /*
                comp1:{
                    component: instance,
                    props:{},
                    children:'',
                    result:function(){},
                    cacheResult:string,
                    relateState:boolean
                }
            */
        };
    };
Component.prototype = Object.assign(Component.prototype,{
    template(){},
    update(props,children){
        if(arguments.length>0){
            this.props = props;
            this.children = children;
            this.version = Math.random();
        }
    },
    setState(key,value){
        if( arguments.length == 0 )return;
        this.version = Math.random();
        this.state[key] = value;
        this.node = this.node || document.getElementById('comp'+this.compUid);
        this.reRender();
    },
    render(){
        var _this = this;
        if(arguments.length > 0)_this.update.apply(_this,arguments);
        return `<div data-type="component" id="comp${_this.compUid}">${_this.template()}</div>`;
    },
    reRender(){
        var _this = this;
        renderToDom(this.template(),this.node);
    }
})
// 将组件渲染到dom节点中
function renderToDom(html,parent){
    if(typeof html =='string'){
        parent.innerHTML = html;
    }else{
        parent.appendChild(html);
    }
}

var comp1 = new Component({name:'comp1'});
var comp2 = new Component({name:'comp2'});
var comp3 = new Component({name:'comp3'});

comp1.template= function(){
    var _this = this
    return `<div>
                <p>
                    ${comp3.render()}
                </p>
                <span>分隔符</span>
                ${comp2.render({name:this.state.name},'<i>children<i>')}
            </div>`;
}
comp2.template=function(){
    var _this = this
    return `
            <p>
                this.props.name: ${(!!this.props.name?this.props.name:'为空')}
            </p>
            <div>
                this.children
            </div>
            <strong>
                ${this.state.name}
            </strong>
            `;
}
comp3.template=function(){
    return `<p>${this.state.name}</p>`;
}

    renderToDom(comp1.render(),document.getElementById('app'));
    document.getElementById('change').onclick=function(){
        console.time();
        comp1.setState('name',new Date().getTime());
        // comp3.setState('name',Math.random()*100);
        console.timeEnd();
    }
</script>
</html>
